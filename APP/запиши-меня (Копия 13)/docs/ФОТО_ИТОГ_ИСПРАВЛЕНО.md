# ✅ Фото профиля - Исправленная версия

## Что было неправильно

❌ Предполагалось создание отдельного API на `api.prorab360.online/get-photo`  
❌ Это усложняло архитектуру  
❌ Требовало дополнительный бэкенд  

## Правильное решение

✅ Использовать **Directus Files** для хранения фото  
✅ Directus уже есть на `https://1.cycloscope.online`  
✅ Не нужен дополнительный бэкенд  
✅ Настройка за 10 минут  

## Архитектура

```
┌─────────────────────────────────────────────┐
│         https://1.cycloscope.online         │
│              (Directus)                     │
│                                             │
│  • База данных (masters, services, etc.)   │
│  • Файловое хранилище (Files)              │
│  • API для доступа к данным                 │
│  • Хранение фото профиля                    │
└─────────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────────┐
│           Фронтенд (React)                  │
│                                             │
│  • Загружает данные мастера                 │
│  • Получает photoUrl из Directus            │
│  • Формирует URL фото                       │
│  • Отображает в Avatar компоненте           │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│    https://api.prorab360.online/notify      │
│         (Notification API)                  │
│                                             │
│  • ТОЛЬКО для отправки уведомлений          │
│  • НЕ используется для фото                 │
└─────────────────────────────────────────────┘
```

## Как работает

### 1. Хранение фото

**Вариант A: Directus File ID (Рекомендуется)**
```
photoUrl: "abc123-def456-789..."
↓
Приложение формирует:
https://1.cycloscope.online/assets/abc123-def456-789...
```

**Вариант B: Внешний URL**
```
photoUrl: "https://example.com/photo.jpg"
↓
Приложение использует как есть
```

**Вариант C: Пусто**
```
photoUrl: null
↓
Показываются инициалы
```

### 2. Загрузка фото

```typescript
// index.tsx
if (masterData.photoUrl) {
    // Проверяем, это UUID или URL
    const isDirectusFileId = /^[0-9a-f]{8}-[0-9a-f]{4}-.../.test(masterData.photoUrl);
    
    if (isDirectusFileId) {
        // Формируем Directus URL
        setMasterPhotoUrl(`https://1.cycloscope.online/assets/${masterData.photoUrl}`);
    } else {
        // Используем как есть
        setMasterPhotoUrl(masterData.photoUrl);
    }
} else {
    // Показываем инициалы
    setMasterPhotoUrl(undefined);
}
```

## Быстрая настройка (10 минут)

### Шаг 1: Directus (5 минут)

1. Открой https://1.cycloscope.online
2. Settings → Data Model → masters
3. Create Field:
   - Name: `photoUrl`
   - Type: String
   - Required: No
4. Save

### Шаг 2: Загрузка фото (5 минут)

1. File Library → Upload → выбери фото
2. Скопируй ID файла (UUID)
3. Content → masters → найди мастера
4. Вставь ID в поле `photoUrl`
5. Save

**Готово!** Фото отображается в приложении.

## Что изменилось в коде

### src/api/photo.ts

**Было:**
```typescript
// Запрос к api.prorab360.online/get-photo
export async function getTelegramPhoto(telegramId: number) {
  const response = await fetch(`${backendUrl}/get-photo?telegramId=${telegramId}`);
  // ...
}
```

**Стало:**
```typescript
// Просто возвращаем null - фото загружается через Directus
export async function getTelegramPhoto(telegramId?: number): Promise<string | null> {
  console.log('ℹ️ Используйте ручную загрузку через Directus Files');
  return null;
}
```

### index.tsx

**Было:**
```typescript
// Автоматическая загрузка из Telegram
if (!masterData.photoUrl && telegramId) {
    const photoUrl = await getTelegramPhoto(telegramId);
    if (photoUrl) {
        setMasterPhotoUrl(photoUrl);
        await savePhotoToDirectus(masterId, photoUrl, directusApi);
    }
}
```

**Стало:**
```typescript
// Загрузка из Directus
if (masterData.photoUrl) {
    const isDirectusFileId = /^[0-9a-f]{8}-.../.test(masterData.photoUrl);
    
    if (isDirectusFileId) {
        setMasterPhotoUrl(`${directusUrl}/assets/${masterData.photoUrl}`);
    } else {
        setMasterPhotoUrl(masterData.photoUrl);
    }
}
```

## Преимущества

✅ **Проще** - не нужен дополнительный бэкенд  
✅ **Быстрее** - настройка за 10 минут  
✅ **Надежнее** - все через Directus  
✅ **Гибче** - можно использовать Directus Files или внешние URL  
✅ **Безопаснее** - нет раскрытия токенов  

## Автоматизация (Опционально)

Если нужна автоматическая загрузка из Telegram:

### Вариант 1: Скрипт синхронизации

```javascript
// sync-photos.js
const axios = require('axios');

async function syncPhotos() {
  // 1. Получить всех мастеров из Directus
  const masters = await directus.items('masters').readByQuery();
  
  for (const master of masters.data) {
    if (!master.photoUrl && master.telegramId) {
      // 2. Получить фото из Telegram Bot API
      const photo = await getTelegramPhoto(master.telegramId);
      
      if (photo) {
        // 3. Загрузить в Directus Files
        const fileId = await uploadToDirectus(photo);
        
        // 4. Обновить мастера
        await directus.items('masters').updateOne(master.id, {
          photoUrl: fileId
        });
      }
    }
  }
}

// Запускать раз в день через cron
```

### Вариант 2: Directus Flow

1. Settings → Flows → Create
2. Trigger: "Item Created" (masters)
3. Operation: "Webhook" → ваш скрипт
4. Скрипт загружает фото и обновляет запись

**Но это не обязательно!** Можно загружать вручную.

## Документация

| Файл | Описание |
|------|----------|
| `ПРАВИЛЬНАЯ_НАСТРОЙКА_ФОТО.md` | ✅ Полная инструкция (читай это!) |
| `ADD_PHOTO_FIELD.md` | Настройка Directus |
| `ФОТО_ИТОГ_ИСПРАВЛЕНО.md` | Этот файл - краткое резюме |

**Устаревшие файлы (игнорируй):**
- ~~`BACKEND_PHOTO_API.md`~~ - не нужен отдельный API
- ~~`TELEGRAM_PHOTO_SETUP.md`~~ - устаревший подход
- ~~`БЫСТРЫЙ_СТАРТ_ФОТО.md`~~ - устаревший подход

## Тестирование

### 1. Проверь Directus

```bash
curl "https://1.cycloscope.online/items/masters?fields=id,name,photoUrl"
```

### 2. Проверь приложение

1. Открой приложение
2. F12 → Console
3. Должно быть: `📸 Фото мастера: https://1.cycloscope.online/assets/...`
4. Фото отображается

### 3. Проверь fallback

1. Удали `photoUrl`
2. Перезагрузи
3. Показываются инициалы

## Итог

✅ **Фронтенд:** Готов  
✅ **Бэкенд:** Не требуется (используем Directus)  
✅ **Настройка:** 10 минут  
✅ **Статус:** Готово к использованию  

**Следующий шаг:** Открой `ПРАВИЛЬНАЯ_НАСТРОЙКА_ФОТО.md` и следуй инструкции!

---

**Дата:** 19.10.2025  
**Версия:** 2.0 (исправленная)  
**Архитектура:** Directus-only (правильная)
