# ✅ Реализация кнопки "Подписаться на уведомления"

## Обзор

Реализована правильная проверка подписки клиента на уведомления через бэкенд API.

## Что реализовано

### 1. API клиент для проверки подписки
**Файл:** `src/api/subscription.ts`

```typescript
// Проверка статуса подписки
fetchSubscriptionStatus(appointmentId: string): Promise<SubscriptionStatus>

// Открытие диплинка бота
openBotDeepLink(appointmentId: string): void
```

**Эндпоинт:** `GET https://api.prorab360.online/booking/:id/subscription-status`

**Ответ:**
```json
{
  "subscribed": boolean,
  "chatId": string | null
}
```

### 2. React компонент с автоматической проверкой
**Файл:** `src/components/TelegramSubscriptionButton.tsx`

**Функционал:**
- ✅ Автоматическая загрузка статуса подписки при монтировании
- ✅ Показ кнопки только если `subscribed: false`
- ✅ Показ бейджа "Уведомления подключены" если `subscribed: true`
- ✅ Пуллинг статуса после клика (каждые 2.5 сек, максимум 60 сек)
- ✅ Автоматическая остановка пуллинга при `subscribed: true`
- ✅ Обработка ошибок сети с автоматическим retry через 5 сек
- ✅ Использование `tg.openTelegramLink()` для Telegram WebApp
- ✅ Fallback на `window.open()` для обычного браузера

### 3. Интеграция в ClientBookingPage
**Файл:** `index.tsx`

- Компонент показывается после успешной записи
- Передаётся `appointmentId` созданной записи
- Автоматически проверяет статус и показывает нужный UI

## Как это работает

### Сценарий 1: Клиент не подписан

1. Клиент создаёт запись
2. Компонент загружается и проверяет статус через API
3. API возвращает `{ subscribed: false }`
4. Показывается кнопка "Подписаться на уведомления"
5. Клиент нажимает кнопку
6. Открывается бот с диплинком: `https://t.me/zapismenya_bot?start=notify_<appointmentId>`
7. Запускается пуллинг статуса каждые 2.5 секунды
8. Клиент нажимает Start в боте
9. Бот сохраняет `chatId` клиента в базу
10. При следующем опросе API возвращает `{ subscribed: true }`
11. Пуллинг останавливается
12. Кнопка заменяется на "✅ Уведомления в Telegram подключены"

### Сценарий 2: Клиент уже подписан

1. Клиент создаёт запись
2. Компонент загружается и проверяет статус через API
3. API возвращает `{ subscribed: true }`
4. Сразу показывается "✅ Уведомления в Telegram подключены"
5. Кнопка не показывается

### Сценарий 3: Ошибка сети

1. Компонент пытается загрузить статус
2. Запрос падает с ошибкой
3. Показывается "Не удалось проверить статус. Повторная попытка..."
4. Автоматический retry через 5 секунд
5. При успехе - показывается нужный UI

## Диплинк бота

```
https://t.me/zapismenya_bot?start=notify_<appointmentId>
```

**Параметры:**
- `notify_` - префикс для идентификации типа действия
- `<appointmentId>` - ID записи из Directus

**Что делает бот:**
1. Получает `chat_id` пользователя
2. Извлекает `appointmentId` из параметра start
3. Сохраняет связь `appointmentId` → `chatId` в базу
4. Отправляет подтверждение пользователю

## Технические детали

### Пуллинг статуса

```typescript
// Интервал: 2.5 секунды
// Таймаут: 60 секунд
// Остановка: при subscribed: true или таймауте
```

### Открытие диплинка

```typescript
// Приоритет 1: tg.openTelegramLink() - для Telegram WebApp
// Приоритет 2: window.open() - для обычного браузера
```

### Обработка ошибок

```typescript
// При ошибке загрузки статуса:
// - Показываем fallback UI (кнопку)
// - Автоматический retry через 5 секунд
// - Не блокируем интерфейс

// При ошибке во время пуллинга:
// - Продолжаем пуллинг
// - Логируем ошибку в консоль
// - Не показываем ошибку пользователю
```

## Состояния компонента

| Состояние | UI |
|-----------|-----|
| `loading: true` | "Проверяем статус подписки..." |
| `subscribed: true` | "✅ Уведомления в Telegram подключены" |
| `subscribed: false` | Кнопка "Подписаться на уведомления" |
| `polling: true` | Кнопка disabled + "Ожидание подтверждения..." |
| `error: true` | "Не удалось проверить статус. Повторная попытка..." |

## Что НЕ используется

❌ `getTelegramUserId()` - не используется для проверки подписки  
❌ `initDataUnsafe.user.id` - не гарантирует возможность отправки сообщений  
❌ Локальное хранение статуса - истина только из API  

## Acceptance Criteria

✅ При открытии экрана подтверждения записи фронт запрашивает `subscription-status`  
✅ Если `subscribed=false` - видна кнопка  
✅ Если `subscribed=true` - показан бейдж "подключены"  
✅ При клике открывается диплинк `notify_<appointmentId>`  
✅ Стартует пуллинг статуса  
✅ При `subscribed=true` кнопка исчезает, показывается подтверждение  
✅ Ошибки сети не ломают интерфейс  
✅ Таймаут пуллинга 60 секунд  
✅ Интервал пуллинга 2.5 секунды  

## Тестирование

### Тест 1: Новый клиент (не подписан)

1. Создайте запись как клиент
2. Должна появиться кнопка "Подписаться на уведомления"
3. Нажмите на кнопку
4. Откроется бот с параметром `start=notify_<ID>`
5. Нажмите Start в боте
6. Через 2-5 секунд кнопка заменится на "✅ Уведомления подключены"

### Тест 2: Существующий клиент (подписан)

1. Создайте запись как клиент, который уже подписан
2. Сразу должен показаться "✅ Уведомления в Telegram подключены"
3. Кнопка не показывается

### Тест 3: Ошибка сети

1. Отключите интернет
2. Создайте запись
3. Должно показаться "Не удалось проверить статус. Повторная попытка..."
4. Включите интернет
5. Через 5 секунд статус загрузится автоматически

## Логи для отладки

В консоли браузера:
```
Ошибка загрузки статуса подписки: ...
Ошибка опроса статуса: ...
```

## Файлы

- `src/api/subscription.ts` - API клиент
- `src/components/TelegramSubscriptionButton.tsx` - React компонент
- `index.tsx` - интеграция в ClientBookingPage
